<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Local ChatOps Desk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header { padding:12px 16px; background:#0f172a; color:#fff; display:flex; gap:12px; align-items:center; }
    header h1 { margin:0; font-size:16px; }
    main { display:grid; grid-template-columns: 360px 1fr; height: calc(100vh - 52px); }
    .panel { border-right:1px solid #e5e7eb; padding:12px; overflow:auto; }
    .chat input, .chat button { padding:8px; font-size:14px; }
    .chat input { width: calc(100% - 90px); }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; white-space: pre-wrap; }
    .status { padding:6px 8px; border-radius:8px; display:inline-block; font-size:12px; }
    .queued { background:#f3f4f6; }
    .running{ background:#e0f2fe; }
    .done   { background:#dcfce7; }
    .failed { background:#fee2e2; }
    .paused { background:#fef9c3; }
    .row { border-bottom:1px solid #eee; padding:8px 0; }
    .muted { color:#6b7280; }
    .flex { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
<header>
  <h1>Local ChatOps Desk</h1>
  <span class="muted">Chat with Claude · Run PR→main · See live logs</span>
</header>
<main>
  <section class="panel">
    <h3>Chat</h3>
    <div class="chat flex">
      <input id="chatInput" placeholder="Type / ask Claude…" />
      <button onclick="sendChat()">Send</button>
    </div>

    <h3 style="margin-top:16px;">GitHub Actions</h3>
    <div class="flex">
      <input id="headBranch" placeholder="head branch (e.g. claude/feature-x)" />
      <button onclick="runPr()">PR → main</button>
    </div>
    <div class="muted" style="margin-top:6px;">Requires <code>GITHUB_PAT</code> with <code>repo</code> scope in <code>.env</code>.</div>

    <h3 style="margin-top:16px;">Tasks</h3>
    <div id="tasks"></div>
  </section>

  <section class="panel">
    <h3>Log</h3>
    <div id="log" class="log"></div>
  </section>
</main>

<script>
  const tasks = new Map();
  const es = new EventSource('/api/events');
  es.onmessage = (e)=>{ try {
    const d = JSON.parse(e.data);
    if (d.kind==='new') tasks.set(d.id, d.task);
    if (d.kind==='status') { const t = tasks.get(d.id); if (t) { t.status = d.status; t.meta = d.meta; } }
    if (d.kind==='log') appendLog(d.line);
    renderTasks();
  } catch(_){} };

  async function loadTasks(){ const j = await (await fetch('/api/tasks')).json(); j.forEach(t=>tasks.set(t.id,t)); renderTasks(); }
  function badge(s){ return `<span class="status ${s}">${s}</span>`; }
  function renderTasks(){
    const el = document.getElementById('tasks');
    el.innerHTML = [...tasks.values()].sort((a,b)=>a.createdAt<b.createdAt?1:-1).map(t=>`
      <div class="row">
        <div><b>${t.type}</b> ${badge(t.status)} <span class="muted">#${t.id}</span></div>
        ${t.status==='paused'&&t.meta?.required?`<div>Required: <code>${t.meta.required.join(', ')}</code></div>`:''}
        ${t.status==='done'&&t.meta?.result?`<pre>${escapeHtml(t.meta.result.slice(0,500))}</pre>`:''}
        ${t.status==='done'&&t.meta?.url?`<div><a href="${t.meta.url}" target="_blank">${t.meta.url}</a></div>`:''}
      </div>`).join('');
  }
  function appendLog(line){ const el=document.getElementById('log'); el.innerText += `[${line.ts}] ${line.level.toUpperCase()} ${line.msg} ${line.meta?JSON.stringify(line.meta):''}\n`; el.scrollTop=el.scrollHeight; }
  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));}

  async function sendChat(){
    const prompt = document.getElementById('chatInput').value.trim();
    if(!prompt) return; const r = await fetch('/api/tasks/chat',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({prompt})}); const t = await r.json(); tasks.set(t.id,t); renderTasks();
  }
  async function runPr(){
    const head = document.getElementById('headBranch').value.trim();
    if(!head) return alert('Enter head branch'); const r = await fetch('/api/tasks/pr-to-main',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({head})}); const t = await r.json(); tasks.set(t.id,t); renderTasks();
  }
  loadTasks();
</script>
</body>
</html>
