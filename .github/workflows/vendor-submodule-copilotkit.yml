name: Vendor – Add/Verify CopilotKit Submodule

on:
  workflow_dispatch:
  pull_request:
    types: [labeled, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  add-or-verify:
    # If triggered by PR label, require 'vendor:add-copilotkit'
    if: github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'vendor:add-copilotkit')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref_name }}
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          submodules: false

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Ensure docs entry
        run: |
          mkdir -p docs
          touch docs/agent-files-to-clone.txt
          if ! grep -q "https://github.com/CopilotKit/CopilotKit" docs/agent-files-to-clone.txt; then
            echo "https://github.com/CopilotKit/CopilotKit" >> docs/agent-files-to-clone.txt
          fi

      - name: Add CopilotKit submodule if missing
        run: |
          mkdir -p vendor
          if [ ! -d vendor/CopilotKit ]; then
            git submodule add https://github.com/CopilotKit/CopilotKit.git vendor/CopilotKit
          else
            echo "Submodule directory exists; skipping add."
          fi

      - name: Commit & push (if changes)
        run: |
          git add .gitmodules vendor/CopilotKit docs/agent-files-to-clone.txt
          if ! git diff --cached --quiet; then
            git commit -m "chore(vendor): add CopilotKit submodule"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Verify submodule is initialized
        run: |
          git submodule update --init --recursive
          echo "Status:"
          git submodule status
          test -f .gitmodules
          test -d vendor/CopilotKit/.git || true

      - name: Comment success on PR (if in PR context)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: "✅ CopilotKit submodule present and verified."
            });
