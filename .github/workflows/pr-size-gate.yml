name: PR Size Gate
run-name: "${{ github.workflow }} — ${{ github.event_name == 'pull_request' && format('#{0}', github.event.pull_request.number) || github.ref_name }}"
on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
permissions:
  contents: read
  pull-requests: write
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
jobs:
  size-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR size (files ≤ 10, changes ≤ 500)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const pr    = context.payload.pull_request;
            const num   = pr.number;

            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number: num, per_page: 100 }
            );
            const fileCount    = files.length;
            const totalChanges = files.reduce((s,f)=> s + (f.changes || 0), 0);

            core.notice(`fileCount=${fileCount}, totalChanges=${totalChanges}`);

            const MAX_FILES   = 10;
            const MAX_CHANGES = 700;

            if (fileCount > MAX_FILES || totalChanges > MAX_CHANGES) {
              const msg = [
                '⚠️ PR too large for policy.',
                '',
                `- Files: **${fileCount}** (limit ${MAX_FILES})`,
                `- Changes: **${totalChanges}** (limit ${MAX_CHANGES})`,
                '',
                'Please split this PR into smaller chunks.'
              ].join('\n');
              await github.rest.issues.createComment({ owner, repo, issue_number: num, body: msg });
              core.setFailed(`PR too large (files=${fileCount}, changes=${totalChanges})`);
            } else {
              core.notice('PR within size policy.');
            }
