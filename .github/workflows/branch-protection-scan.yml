name: Branch Protection Scan / scan

on:
  pull_request:
    types: [opened, synchronize, reopened]

run-name: "${{ github.workflow }} â€” #${{ github.event.pull_request.number }}"

permissions:
  contents: read
  pull-requests: read
  administration: read   # <-- required to read branch protection

concurrency:
  group: branch-protection-scan-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Check default branch protection
        id: bp
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const repoInfo = await github.rest.repos.get({ owner, repo });
            const defaultBranch = repoInfo.data.default_branch;

            let protected = false;
            let requiredChecks = [];

            try {
              const { data } = await github.request(
                'GET /repos/{owner}/{repo}/branches/{branch}/protection',
                { owner, repo, branch: defaultBranch }
              );
              protected = true;
              requiredChecks = (data?.required_status_checks?.checks || [])
                .map(c => c.context);
            } catch (e) {
              if (e.status !== 404) {
                core.setFailed(`Error querying branch protection: ${e.message}`);
                return;
              }
            }

            await core.summary
              .addHeading('Branch Protection Scan')
              .addRaw(`Default branch: **${defaultBranch}**`).addBreak()
              .addRaw(`Protected: **${protected}**`).addBreak()
              .addRaw(`Required checks: ${requiredChecks.length ? requiredChecks.map(c => '`'+c+'`').join(', ') : '_none_'}`)
              .write();

            core.setOutput('protected', String(protected));

      - name: Warn if not protected (soft gate)
        if: steps.bp.outputs.protected == 'false'
        run: |
          echo "::warning title=Branch Protection::Default branch is not protected or missing required checks."
