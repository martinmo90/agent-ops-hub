name: Auto Open PR on Push

on:
  push:
    branches-ignore:
      - main
      - 'gh-pages'
      - 'dependabot/**'
  workflow_dispatch:
    inputs:
      head:
        description: 'Head branch (source)'
        required: true
        default: ''
      base:
        description: 'Base branch (destination)'
        required: true
        default: 'main'
      draft:
        description: 'Create PR as draft'
        required: true
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-open-pr-${{ github.ref }}
  cancel-in-progress: false

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine branches
        id: br
        run: |
          # From push, head = ref_name; base = main
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "head=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
            echo "base=main" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
          else
            # workflow_dispatch
            echo "head=${{ inputs.head }}" >> $GITHUB_OUTPUT
            echo "base=${{ inputs.base }}" >> $GITHUB_OUTPUT
            echo "draft=${{ inputs.draft }}" >> $GITHUB_OUTPUT
          fi
          echo "ref_name=${GITHUB_REF_NAME}"

      - name: Open PR (head → base)
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: ${{ steps.br.outputs.head }}
          destination_branch: ${{ steps.br.outputs.base }}
          pr_title: "auto: open PR for ${{ steps.br.outputs.head }} → ${{ steps.br.outputs.base }}"
          pr_body: |
            Auto-opened by workflow.
            - Head: `${{ steps.br.outputs.head }}`
            - Base: `${{ steps.br.outputs.base }}`
            - SHA: `${{ github.sha }}`
            - Actor: `${{ github.actor }}`
            - Event: `${{ github.event_name }}`
          pr_draft: ${{ steps.br.outputs.draft }}
          pr_assignee: ""
          pr_reviewer: ""
          pr_label: "auto-opened,ci"
          maintainer_can_modify: true
