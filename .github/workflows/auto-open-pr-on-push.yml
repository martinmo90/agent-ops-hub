name: Auto Open PR on push (cursor/*)
on:
  push:
    branches:
      - 'cursor/**'
  workflow_dispatch:
jobs:
  open:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Ensure a PR exists from the pushed branch to main
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const head  = context.ref.replace('refs/heads/','');
            const base  = 'main';
            // Skip if the head IS main
            if (head === base) {
              core.notice('Head is main; nothing to do.');
              return;
            }
            // List existing PRs from head->base
            const prs = await github.rest.pulls.list({ owner, repo, state: 'open', head: `${owner}:${head}`, base });
            if (prs.data.length) {
              core.notice(`PR already exists: ${prs.data[0].html_url}`);
              return;
            }
            const title = `chore: auto-open PR for ${head}`;
            const body  = `Auto-created PR for branch **${head}** â†’ **${base}**.\n\nSummary:\n- Auto-opened by workflow.\n\nTest Plan:\n- CI runs on PR.\n\nRisks:\n- Low.`;
            const res = await github.rest.pulls.create({ owner, repo, head, base, title, body, draft: true });
            core.notice(`Created PR: ${res.data.html_url}`);
            // Optional: nudge Bugbot by commenting the magic phrase
            await github.rest.issues.createComment({ owner, repo, issue_number: res.data.number, body: 'bugbot run' });
