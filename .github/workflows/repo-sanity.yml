name: Repo Sanity Check
on:
  workflow_dispatch:
jobs:
  sanity:
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    steps:
      - name: Print key repo settings
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const r = await github.rest.repos.get({ owner, repo });
            core.notice(`default_branch=${r.data.default_branch}`);
            core.notice(`private=${r.data.private}`);
            // Actions workflow permissions (best-effort; may require admin to read)
            try {
              const p = await github.request('GET /repos/{owner}/{repo}/actions/permissions', { owner, repo });
              core.notice(`actions.default_workflow_permissions=${p.data.default_workflow_permissions}`);
              core.notice(`actions.can_approve_pull_request_reviews=${p.data.can_approve_pull_request_reviews}`);
            } catch (e) {
              core.warning(`Could not read Actions permissions (admin-only endpoint).`);
            }
            // Branch protection for main (best-effort)
            try {
              const bp = await github.rest.repos.getBranchProtection({ owner, repo, branch: 'main' });
              core.notice(`branch_protection.main.required_status_checks=${!!bp.data.required_status_checks}`);
              core.notice(`branch_protection.main.restrictions=${!!bp.data.restrictions}`);
              core.notice(`branch_protection.main.enforce_admins=${!!bp.data.enforce_admins?.enabled}`);
              core.notice(`branch_protection.main.allow_auto_merge=${!!bp.data.allow_auto_merge}`);
            } catch (e) {
              core.warning(`Could not read branch protection (requires admin).`);
            }
            core.notice('Sanity check complete.');
