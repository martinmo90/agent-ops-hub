name: Required Checks Audit

on:
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: read
  checks: read
  administration: read   # tolerated; if not granted, workflow stays green & prints 'unknown'

concurrency:
  group: req-checks-audit-${{ github.ref }}
  cancel-in-progress: true

jobs:
  audit:
    name: audit
    runs-on: ubuntu-latest
    steps:
      - name: Resolve default branch
        id: def
        uses: actions/github-script@v7
        with:
          script: |
            const { data: repo } = await github.rest.repos.get(context.repo);
            core.setOutput('default', repo.default_branch || 'main');
      - name: Read branch protection (tolerant)
        id: prot
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner, repo = context.repo.repo;
            const base = "${{ steps.def.outputs.default }}";
            let required = [], ok = true, note = "";
            try {
              const { data } = await github.request(
                "GET /repos/{owner}/{repo}/branches/{branch}/protection",
                { owner, repo, branch: base }
              );
              const checks = data?.required_status_checks?.checks || [];
              required = checks.map(c => c.context);
            } catch (e) {
              ok = true; // do not fail in PRs or if scope missing
              note = `Protection API not accessible: ${e.status||''} ${e.message||e}`;
            }
            core.setOutput('required', JSON.stringify(required));
            core.setOutput('note', note);
      - name: Recommend final required checks
        id: rec
        run: |
          cat > rec.txt <<'TXT'
          Baseline Guard / verify
          PR Size Gate / size-gate
          Branch Protection Scan / scan
          Conventional Commits / lint
          Benchmark Zip Exact Check / check
          Build Base44 UI / build
          TXT
          echo "recommended<<EOF" >> $GITHUB_OUTPUT
          cat rec.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Write summary
        run: |
          echo "### Required Checks Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Default branch:** ${{ steps.def.outputs.default }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current (from API, if accessible):**" >> $GITHUB_STEP_SUMMARY
          echo '`${{ steps.prot.outputs.required }}`' >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.prot.outputs.note }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_Note_: ${{ steps.prot.outputs.note }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recommended (copy into Settings → Branches → Required status checks):**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          while IFS= read -r line; do echo "- \`${line}\`" >> $GITHUB_STEP_SUMMARY; done < rec.txt
